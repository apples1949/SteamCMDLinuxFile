name: SteamCMD Upload

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y lib32gcc-s1 python3-pip
        sudo timedatectl set-timezone Asia/Shanghai

    - name: Install Python Dependencies
      run: |
        pip3 install requests base58 pycryptodomex

    - name: Prepare Directories
      run: |
        mkdir -p "$GITHUB_WORKSPACE/build"  
        WORKDIR="$HOME/steamcmd_build"
        mkdir -p "$WORKDIR"
        cd "$WORKDIR"
        echo "Current dir: $(pwd)"

    - name: Download SteamCMD
      run: |
        cd "$HOME/steamcmd_build"
        wget -q https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz
        tar -xzf steamcmd_linux.tar.gz
        rm steamcmd_linux.tar.gz
        ./steamcmd.sh +quit
        chmod -R a+r *

    - name: Create SteamCMD Package
      run: |
        tar -czvf "$GITHUB_WORKSPACE/build/steamcmd_linux.tar.gz" \
          --exclude='linux32/steamclient.so' \
          -C "$HOME/steamcmd_build" \
          linux32 \
          package \
          steamcmd.sh
    
        ls -lh "$GITHUB_WORKSPACE/build"
        echo "Package path: $GITHUB_WORKSPACE/build/steamcmd_linux.tar.gz"

    - name: Compress Package Contents
      run: |
        cd "$HOME/steamcmd_build"
        (cd package && tar -czvf ../package.tar.gz ./*)
        mv package.tar.gz "$GITHUB_WORKSPACE/build/"
        ls -lh "$GITHUB_WORKSPACE/build"
        echo "Package path: $GITHUB_WORKSPACE/build/package.tar.gz"
        
    - name: Upload Package via Script
      run: |
        cd "$GITHUB_WORKSPACE"
        wget -q https://raw.githubusercontent.com/Aruelius/wenshushu/refs/heads/master/wss.py
        python3 wss.py upload build/steamcmd_linux.tar.gz > upload_output.log 2>&1
        cat upload_output.log
        PUBLIC_LINK=$(grep "å…¬å…±é“¾æ¥" upload_output.log | awk -F'ï¼š' '{print $2}' | tr -d '[:space:]')
        echo "PUBLIC_LINK=$PUBLIC_LINK" >> $GITHUB_ENV
        echo "æå–çš„å…¬å…±é“¾æ¥: $PUBLIC_LINK"
        
    - name: Update README with Public Link
      run: |
        SECTION_START="<!-- PUBLIC_LINK_START -->"
        SECTION_END="<!-- PUBLIC_LINK_END -->"
        
        NEW_CONTENT="$SECTION_START\n\ ä»¥ä¸‹ä¸º[æ–‡å”å”](https://www.wenshushu.cn)åŠ é€Ÿé“¾æ¥ï¼š\n"
        NEW_CONTENT+="[$PUBLIC_LINK]($PUBLIC_LINK)\n\n"
        NEW_CONTENT+="åªé€‚ç”¨äºå®åœ¨æ˜¯æ‰¾ä¸åˆ°å…¶ä»–çš„å¿«é€Ÿä¸‹è½½æ¸ é“\n"
        NEW_CONTENT+="$SECTION_END"
        
        # å¦‚æœå­˜åœ¨ç°æœ‰ç»“æœåˆ™æ›¿æ¢ï¼Œå¦åˆ™è¿½åŠ 
        if grep -q "$SECTION_START" README.md; then
          sed -i "/$SECTION_START/,/$SECTION_END/c\\$NEW_CONTENT" README.md
        else
          echo -e "\n$NEW_CONTENT" >> README.md
        fi
        
        echo "âœ… READMEå·²æ›´æ–°"
        echo "æ›´æ–°å†…å®¹ï¼š"
        echo -e "$NEW_CONTENT"
        
    - name: Commit & Push
      run: |
        cd "$GITHUB_WORKSPACE"
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@users.noreply.github.com"

        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

        if [ -n "$(git status --porcelain build/ README.md)" ]; then
          git add build/ README.md
          git commit -m "ğŸ¤– æ›´æ–°SteamCMD ($(date +'%Y-%m-%d %H:%M'))"
          git pull --rebase origin test
          git push origin HEAD:test
          echo "ğŸš€ æ›´æ”¹å·²æ¨é€"
        else
          echo "ğŸŸ¢ æ— æ›´æ”¹å¯æäº¤"
        fi
